<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Detenidos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="theme-color" content="#4285f4">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f0f2f5; 
        }
        .container { 
            background-color: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            max-width: 600px; 
            margin: auto; 
        }
        h1 { 
            color: #4285f4; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #333; 
        }
        input[type="text"], input[type="email"], textarea, select { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box;
            font-size: 16px;
        }
        button { 
            background-color: #4285f4; 
            color: white; 
            padding: 15px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            width: 100%;
            margin-top: 10px;
        }
        button:hover { 
            background-color: #3367d6; 
        }
        .message { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 4px; 
            background-color: #e6ffe6; 
            border: 1px solid #00cc00; 
            color: #006600; 
            display: none; 
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .checkbox-group {
            margin-bottom: 15px;
        }
        .checkbox-group label {
            display: inline;
            margin-left: 8px;
            font-weight: normal;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Registro de Detenidos</h1>
        <form id="detenidoForm">
            <label for="nombre">Nombre del Detenido:</label>
            <input type="text" id="nombre" required>

            <label for="delito">Delito:</label>
            <input type="text" id="delito" required>

            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" required>

            <label for="hora">Hora:</label>
            <input type="time" id="hora" required>

            <label for="lugar">Lugar:</label>
            <input type="text" id="lugar" required>

            <label for="observaciones">Observaciones:</label>
            <textarea id="observaciones" rows="4"></textarea>

            <label>Enviar a:</label>
            <div class="checkbox-group">
                <input type="checkbox" id="gtd" value="javiertnf16@hotmail.com">
                <label for="gtd">GTD (javiertnf16@hotmail.com)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="odac" value="jbejarnavarrete@gmail.com">
                <label for="odac">ODAC (jbejarnavarrete@gmail.com)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="sc" value="jtnf20@gmail.com">
                <label for="sc">S.C. (jtnf20@gmail.com)</label>
            </div>

            <label for="password">Contrase√±a para proteger el archivo:</label>
            <input type="text" id="password" value="detenido2024" required>

            <button type="submit">üìß Generar y Enviar</button>
        </form>
        
        <div class="loading" id="loading">
            <p>‚è≥ Generando archivo...</p>
        </div>
        
        <div id="message" class="message"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        document.getElementById('detenidoForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('message').style.display = 'none';

            try {
                // Recoger datos del formulario
                const nombre = document.getElementById('nombre').value;
                const delito = document.getElementById('delito').value;
                const fecha = document.getElementById('fecha').value;
                const hora = document.getElementById('hora').value;
                const lugar = document.getElementById('lugar').value;
                const observaciones = document.getElementById('observaciones').value;
                const password = document.getElementById('password').value;

                // Recoger destinatarios seleccionados
                const destinatarios = [];
                if (document.getElementById('gtd').checked) destinatarios.push('javiertnf16@hotmail.com');
                if (document.getElementById('odac').checked) destinatarios.push('jbejarnavarrete@gmail.com');
                if (document.getElementById('sc').checked) destinatarios.push('jtnf20@gmail.com');

                if (destinatarios.length === 0) {
                    alert('‚ö†Ô∏è Selecciona al menos un destinatario');
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                // Crear datos para el Excel
                const data = [
                    ["Campo", "Valor"],
                    ["Nombre del Detenido", nombre],
                    ["Delito", delito],
                    ["Fecha", fecha],
                    ["Hora", hora],
                    ["Lugar", lugar],
                    ["Observaciones", observaciones],
                    ["Fecha/Hora de Registro", new Date().toLocaleString()]
                ];

                // 1. Generar Excel
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Registro Detenido");
                
                // Formatear el Excel
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = XLSX.utils.encode_cell({c: C, r: R});
                        if (!ws[cell_address]) continue;
                        if (R === 0) { // Primera fila (encabezados)
                            ws[cell_address].s = {
                                font: { bold: true, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "4285F4" } }
                            };
                        }
                    }
                }

                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

                // 2. Cifrar el contenido del Excel
                const excelBase64 = btoa(String.fromCharCode.apply(null, new Uint8Array(excelBuffer)));
                const encrypted = CryptoJS.AES.encrypt(excelBase64, password).toString();

                // 3. Crear ZIP con el contenido cifrado
                const zip = new JSZip();
                zip.file("DETENIDO_CIFRADO.txt", encrypted);
                zip.file("INSTRUCCIONES.txt", `Este archivo contiene un registro de detenido cifrado.
Para descifrarlo:
1. Copia el contenido de DETENIDO_CIFRADO.txt
2. Usa la contrase√±a: ${password}
3. Contacta con el administrador para obtener la herramienta de descifrado.

Fecha de creaci√≥n: ${new Date().toLocaleString()}`);

                const zipBlob = await zip.generateAsync({ type: "blob", compression: "DEFLATE" });

                // 4. Preparar email
                const timestamp = new Date().toISOString().slice(0,16).replace('T', '_');
                const fileName = `DETENIDO_${timestamp}.zip`;
                
                const emailSubject = `Nuevo registro de detenido por ${delito}`;
                const emailBody = `Se adjunta registro de detenido cifrado.

Detalles:
- Nombre: ${nombre}
- Delito: ${delito}
- Fecha: ${fecha} ${hora}
- Lugar: ${lugar}

El archivo est√° protegido con contrase√±a.
Contrase√±a: ${password}`;

                // 5. Guardar archivo y abrir email
                saveAs(zipBlob, fileName);

                // Enviar notificaci√≥n a adeje.gtd@hotmail.com
                const notificationSubject = `Nuevo registro de detenido por ${delito}`;
                const notificationBody = `Se ha registrado un nuevo detenido.

Delito: ${delito}
Fecha: ${fecha} ${hora}
Lugar: ${lugar}`;

                // Intentar usar la API nativa de compartir
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([zipBlob], fileName, { type: 'application/zip' })] })) {
                    try {
                        await navigator.share({
                            files: [new File([zipBlob], fileName, { type: 'application/zip' })],
                            title: emailSubject,
                            text: emailBody,
                        });
                        showMessage('‚úÖ Archivo generado y compartido correctamente');
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            fallbackEmail(destinatarios, emailSubject, emailBody, fileName);
                        }
                    }
                } else {
                    fallbackEmail(destinatarios, emailSubject, emailBody, fileName);
                }

                // Enviar notificaci√≥n separada
                setTimeout(() => {
                    const notificationLink = `mailto:adeje.gtd@hotmail.com?subject=${encodeURIComponent(notificationSubject)}&body=${encodeURIComponent(notificationBody)}`;
                    window.open(notificationLink, '_blank');
                }, 2000);

                // Limpiar formulario
                document.getElementById('detenidoForm').reset();
                document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
                document.getElementById('hora').value = new Date().toTimeString().slice(0,5);

            } catch (error) {
                console.error('Error:', error);
                showMessage('‚ùå Error al generar el archivo: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        function fallbackEmail(destinatarios, subject, body, fileName) {
            const mailtoLink = `mailto:${destinatarios.join(',')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
            showMessage(`‚úÖ Archivo "${fileName}" descargado. Se ha abierto tu cliente de correo. Adjunta el archivo manualmente.`);
        }

        function showMessage(text) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 10000);
        }

        // Inicializar fecha y hora actuales
        window.addEventListener('load', () => {
            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('hora').value = new Date().toTimeString().slice(0,5);
        });

        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('SW registrado'))
                    .catch(error => console.log('SW error:', error));
            });
        }
    </script>
</body>
</html>