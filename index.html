<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Detenidos</title>
  <link rel="manifest" href="manifest.json">

  <!-- Fuente Comfortaa -->
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://gildas-lormeau.github.io/zip.js/demos/lib/zip.min.js"></script>

  <style>
    body {
      font-family: 'Comfortaa', sans-serif; 
      margin: 20px;
      background: url('fondo.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    h1 { 
      text-align: center; 
      text-transform: uppercase;
      color: #2c3e50;
      font-size: 2.2em;
      margin-bottom: 30px;
    }
    form {
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 650px;
      margin: auto;
      backdrop-filter: blur(2px);
    }
    label { 
      display: block; 
      margin-top: 15px; 
      text-transform: uppercase;
      color: #34495e;
      font-size: 1.1em;
    }
    input, select, textarea { 
      width: 100%; 
      padding: 10px; 
      margin-top: 6px; 
      font-family: 'Comfortaa', sans-serif;
      font-weight: 400;
      border: 2px solid #bdc3c7;
      border-radius: 5px;
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
    }
    button { 
      margin-top: 25px; 
      padding: 12px; 
      background: #3498db; 
      color: white;
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      width: 100%;
      font-family: 'Comfortaa', sans-serif;
      font-weight: 700;
      font-size: 16px;
      text-transform: uppercase;
    }
    button:hover { background: #2980b9; }
    #message { 
      margin-top: 20px; 
      font-weight: bold; 
      text-align: center; 
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>Registro de Detenidos</h1>
  <form id="registroForm">
    <label>TIPO DOCUMENTO:
      <select name="TIPO DOCUMENTO_OPCION">
        <option value="DNI" selected>DNI</option>
        <option value="NIE">NIE</option>
        <option value="INDOCUMENTADO">INDOCUMENTADO</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="TIPO DOCUMENTO" placeholder="Especificar otro" style="display:none;">
    </label>

    <label>NºDOCUMENTO: <input type="text" name="NºDOCUMENTO"></label>
    <label>SEXO:
      <select name="SEXO_OPCION">
        <option value="MASCULINO" selected>MASCULINO</option>
        <option value="FEMENINO">FEMENINO</option>
      </select>
    </label>
    <label>NOMBRE: <input type="text" name="Nombre"></label>
    <label>APELLIDOS: <input type="text" name="APELLIDOS"></label>
    <label>NOMBRE DE LOS PADRES: <input type="text" name="Nombre de los Padres"></label>
    <label>FECHA DE NACIMIENTO: <input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></label>
    <label>LUGAR DE NACIMIENTO: <input type="text" name="LUGAR DE NACIMIENTO"></label>
    <label>NACIONALIDAD: <input type="text" name="NACIONALIDAD"></label>

    <label>DOMICILIO:
      <select name="DOMICILIO_OPCION">
        <option value="NO APORTA" selected>NO APORTA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="DOMICILIO" placeholder="Especificar domicilio" style="display:none;">
    </label>

    <label>TELÉFONO:
      <select name="TELÉFONO_OPCION">
        <option value="NO APORTA" selected>NO APORTA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="TELÉFONO" placeholder="Especificar teléfono" style="display:none;">
    </label>

    <label>DELITO: <input type="text" name="DELITO"></label>
    <label>C.P. AGENTES: <input type="text" name="C.P. AGENTES"></label>
    <label>DILIGENCIAS: <input type="text" name="DILIGENCIAS"></label>
    <label>LUGAR DEL HECHO: <input type="text" name="LUGAR DEL HECHO"></label>
    <label>LUGAR DE LA DETENCIÓN: <input type="text" name="LUGAR DE LA DETENCIÓN"></label>
    <label>HORA DEL HECHO: <input type="text" name="HORA DEL HECHO" placeholder="HH:MM"></label>
    <label>HORA DE LA DETENCIÓN: <input type="text" name="HORA DE LA DETENCIÓN" placeholder="HH:MM"></label>
    <label>BREVE RESUMEN DE LOS HECHOS:
      <textarea name="BREVE RESUMEN DE LOS HECHOS" rows="3"></textarea>
    </label>
    <label>INDICIOS POR LOS QUE SE DETIENE:
      <textarea name="INDICIOS POR LOS QUE SE DETIENE" rows="3"></textarea>
    </label>

    <label>ABOGADO:
      <select name="ABOGADO_OPCION">
        <option value="DE OFICIO" selected>DE OFICIO</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="ABOGADO" placeholder="Especificar abogado" style="display:none;">
    </label>

    <label>COMUNICARSE CON:
      <select name="COMUNICARSE CON_OPCION">
        <option value="NADIE" selected>NADIE</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="COMUNICARSE CON" placeholder="Especificar contacto" style="display:none;">
    </label>

    <label>OTROS DERECHOS:
      <select name="OTROS DERECHOS" multiple size="3">
        <option value="MEDICO">MÉDICO</option>
        <option value="CONSULADO">CONSULADO</option>
        <option value="INTERPRETE">INTÉRPRETE</option>
      </select>
    </label>

    <label>INTÉRPRETE:
      <select name="INTERPRETE_OPCION">
        <option value="NO" selected>NO</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="INTERPRETE" placeholder="Especificar idioma" style="display:none;">
    </label>

    <button type="submit">Generar archivo</button>
  </form>

  <div id="message"></div>

  <script>
    // Mostrar input "OTRO"
    document.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', function() {
        const textInput = this.closest('label').querySelector('input[type="text"]');
        if (textInput) {
          textInput.style.display = (this.value === 'OTRO') ? 'block' : 'none';
          if (this.value !== 'OTRO') textInput.value = '';
        }
      });
    });

    function showMessage(msg) {
      document.getElementById("message").innerText = msg;
    }

    document.getElementById("registroForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {};

      // Asignar select + "OTRO"
      const tipoDoc = formData.get("TIPO DOCUMENTO_OPCION") === "OTRO" ? formData.get("TIPO DOCUMENTO") : formData.get("TIPO DOCUMENTO_OPCION");
      data["TIPO DOCUMENTO"] = tipoDoc.toUpperCase();

      const sexo = formData.get("SEXO_OPCION");
      data["SEXO"] = sexo.toUpperCase();

      const domicilio = formData.get("DOMICILIO_OPCION") === "OTRO" ? formData.get("DOMICILIO") : formData.get("DOMICILIO_OPCION");
      data["DOMICILIO"] = domicilio.toUpperCase();

      const tel = formData.get("TELÉFONO_OPCION") === "OTRO" ? formData.get("TELÉFONO") : formData.get("TELÉFONO_OPCION");
      data["TELÉFONO"] = tel.toUpperCase();

      const abo = formData.get("ABOGADO_OPCION") === "OTRO" ? formData.get("ABOGADO") : formData.get("ABOGADO_OPCION");
      data["ABOGADO"] = abo.toUpperCase();

      const com = formData.get("COMUNICARSE CON_OPCION") === "OTRO" ? formData.get("COMUNICARSE CON") : formData.get("COMUNICARSE CON_OPCION");
      data["COMUNICARSE CON:"] = com.toUpperCase();

      // INTÉRPRETE
      const interpreteSel = formData.get("INTERPRETE_OPCION");
      const interpreteOtro = formData.get("INTERPRETE");
      data["INTERPRETE"] = (interpreteSel === "OTRO" && interpreteOtro) ? interpreteOtro.toUpperCase() : "NO";

      // OTROS DERECHOS
      const otros = formData.getAll("OTROS DERECHOS");
      data["OTROS DERECHOS"] = otros.length ? otros.map(v => v.toUpperCase()).join(", ") : "NINGUNO";

      // Resto de campos libres (Nombre, Resumen, etc)
      formData.forEach((value, key) => {
        if (value && value.trim() !== "" && !key.includes("_OPCION") && !["TIPO DOCUMENTO","DOMICILIO","TELÉFONO","ABOGADO","COMUNICARSE CON","INTERPRETE"].includes(key)) {
          data[key] = value.toUpperCase();
        }
      });

      // Cabeceras fijas
      const headers = [
        "TIPO DOCUMENTO","NºDOCUMENTO","SEXO","Nombre","APELLIDOS","Nombre de los Padres",
        "FECHA DE NACIMIENTO","LUGAR DE NACIMIENTO","NACIONALIDAD","DOMICILIO","TELÉFONO",
        "DELITO","C.P. AGENTES","DILIGENCIAS","LUGAR DEL HECHO","LUGAR DE LA DETENCIÓN",
        "HORA DEL HECHO","HORA DE LA DETENCIÓN","BREVE RESUMEN DE LOS HECHOS",
        "INDICIOS POR LOS QUE SE DETIENE","ABOGADO","COMUNICARSE CON:","OTROS DERECHOS",
        "INTERPRETE"
      ];
      const row = {};
      headers.forEach(h => row[h] = data[h] || "");

      // Excel
      const ws = XLSX.utils.json_to_sheet([row], { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Registro");

      const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

      try {
        const writer = new zip.ZipWriter(new zip.BlobWriter("application/zip"), {
          password: "americas",
          encryptionStrength: 3
        });
        await writer.add("DETENIDO.xlsx", new zip.BlobReader(blob));
        const zipBlob = await writer.close();
        saveAs(zipBlob, "DETENIDO.zip");
        showMessage("✅ Archivo 'DETENIDO.zip' generado y descargado.\nProtegido con contraseña: americas");
      } catch (err) {
        saveAs(blob, "DETENIDO.xlsx");
        showMessage("⚠️ No se pudo cifrar ZIP, se descargó Excel sin proteger.");
      }
    });
  </script>
</body>
</html>
